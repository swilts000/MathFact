 /**
         * Represents a single scrolling number (an "Invader").
         */
        class Invader {
            constructor(value, gameArea, speedSetting) {
                this.value = value;
                this.gameArea = gameArea;
                this.y = -50; // Start off-screen
                // Ensure X position respects padding/margins for mobile width
                this.x = Math.random() * (gameArea.clientWidth - 80) + 10;
                
                // Set speed based on setting (Extra Slower values implemented here)
                switch(speedSetting) {
                    case 'easy':
                        // Slowest: 0.1 - 0.4 pixels/frame (Very forgiving)
                        this.speed = 0.1 + Math.random() * 0.3; 
                        break;
                    case 'fast':
                        // Fastest: 0.7 - 1.2 pixels/frame
                        this.speed = 0.7 + Math.random() * 0.5; 
                        break;
                    case 'intermediate':
                    default:
                        // Medium: 0.3 - 0.7 pixels/frame
                        this.speed = 0.3 + Math.random() * 0.4; 
                }
                
                this.element = document.createElement('div');
                this.element.className = 'invader';
                this.element.textContent = this.value;
                this.element.style.left = `${this.x}px`;
                this.element.style.top = `${this.y}px`;
                
                this.gameArea.appendChild(this.element);
            }

            update() {
                this.y += this.speed;
                this.element.style.top = `${this.y}px`;
            }

            isOffScreen() {
                return this.y > this.gameArea.clientHeight;
            }

            destroy() {
                if (this.element.parentElement) {
                    this.gameArea.removeChild(this.element);
                }
            }
        }

        /**
         * Manages the entire game state, UI, and logic.
         */
        class Game {
            constructor() {
                // DOM Element Cache
                this.settingsScreen = document.getElementById('settings-screen');
                this.gameScreen = document.getElementById('game-screen');
                this.gameOverScreen = document.getElementById('game-over-screen');
                this.startGameBtn = document.getElementById('start-game');
                this.restartGameBtn = document.getElementById('restart-game');
                this.quitGameBtn = document.getElementById('quit-game'); // NEW Button
                this.gameArea = document.getElementById('game-area');
                this.multiplierDisplay = document.getElementById('multiplier');
                this.fixedMultiplierContainer = document.getElementById('fixed-multiplier-container');
                
                // Keypad related elements
                this.answerDisplay = document.getElementById('answer-display');
                this.keypad = document.getElementById('keypad');
                
                this.scoreRightDisplay = document.getElementById('score-right');
                this.scoreWrongDisplay = document.getElementById('score-wrong');
                this.gameStatusDisplay = document.getElementById('game-status');
                this.finalScoreRight = document.getElementById('final-score-right');
                this.finalScoreWrong = document.getElementById('final-score-wrong');
                this.gameOverTitle = document.getElementById('game-over-title');
                this.gameAlert = document.getElementById('game-alert');

                // Game State
                this.settings = {};
                this.scoreRight = 0;
                this.scoreWrong = 0;
                this.multiplier = 0;
                this.invaders = [];
                this.gameLoopId = null;
                this.timerId = null;
                this.timeLeft = 0;
                this.spawnInterval = 2500;
                this.lastSpawnTime = 0;
                this.alertTimer = null;
                this.currentAnswer = '';

                // Bind event listeners
                this.startGameBtn.addEventListener('click', () => this.start());
                this.restartGameBtn.addEventListener('click', () => this.showSettings());
                this.quitGameBtn.addEventListener('click', () => this.showSettings()); // NEW Bind
                
                // Keypad listener (Handles touch and click)
                this.keypad.addEventListener('click', (e) => {
                    const key = e.target.closest('button')?.dataset.key;
                    if (key) {
                        this.handleKeypadInput(key);
                    }
                });
                
                // Allow keyboard number input for desktop users
                document.addEventListener('keydown', (e) => {
                    if (this.gameScreen.style.display === 'block') {
                        const key = e.key;
                        if (key >= '0' && key <= '9') {
                            this.handleKeypadInput(key);
                        } else if (key === 'Enter') {
                            this.handleKeypadInput('submit');
                            e.preventDefault(); // Prevent accidental form submission if this were a form
                        } else if (key === 'Backspace') {
                            this.handleKeypadInput('del');
                            e.preventDefault();
                        }
                    }
                });
                
                this.bindSettingsControls();
            }

            bindSettingsControls() {
                const modeRadios = document.querySelectorAll('input[name="mode"]');
                const timeInputContainer = document.getElementById('time-limit-container');
                const scoreInputContainer = document.getElementById('score-limit-container');
                const multiplierModeRadios = document.querySelectorAll('input[name="multiplier_mode"]');
                
                // 1. Game Mode Listener (Time vs Score)
                modeRadios.forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        if (e.target.value === 'time') {
                            timeInputContainer.style.display = 'block';
                            scoreInputContainer.style.display = 'none';
                        } else {
                            timeInputContainer.style.display = 'none';
                            scoreInputContainer.style.display = 'block';
                        }
                    });
                });
                document.querySelector('input[name="mode"]:checked').dispatchEvent(new Event('change'));

                // 2. Multiplier Mode Listener (Random vs Fixed)
                multiplierModeRadios.forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        if (e.target.value === 'fixed') {
                            this.fixedMultiplierContainer.style.display = 'block';
                        } else {
                            this.fixedMultiplierContainer.style.display = 'none';
                        }
                    });
                });
                document.querySelector('input[name="multiplier_mode"]:checked').dispatchEvent(new Event('change'));
            }

            showSettings() {
                this.settingsScreen.style.display = 'block';
                this.gameScreen.style.display = 'none';
                this.gameOverScreen.style.display = 'none';
                this.cleanup();
            }

            getSettings() {
                const difficulty = document.querySelector('input[name="difficulty"]:checked').value;
                const mode = document.querySelector('input[name="mode"]:checked').value;
                const speed = document.querySelector('input[name="speed"]:checked').value;
                const multiplierMode = document.querySelector('input[name="multiplier_mode"]:checked').value;
                
                let timeLimit = parseInt(document.getElementById('time-limit').value, 10);
                let scoreLimit = parseInt(document.getElementById('score-limit').value, 10);
                let fixedMultiplier = parseInt(document.getElementById('fixed-multiplier').value, 10);

                // Input validation and clamping
                if (isNaN(timeLimit) || timeLimit <= 0) timeLimit = 60;
                if (isNaN(scoreLimit) || scoreLimit <= 0) scoreLimit = 20;
                
                if (isNaN(fixedMultiplier) || fixedMultiplier < 1) fixedMultiplier = 1;
                if (fixedMultiplier > 12) fixedMultiplier = 12;

                this.settings = {
                    difficulty,
                    mode,
                    speed,
                    multiplierMode,
                    fixedMultiplier,
                    limit: mode === 'time' ? timeLimit : scoreLimit,
                };
                
                // Update UI inputs to reflect clamped values (for consistency)
                document.getElementById('time-limit').value = timeLimit;
                document.getElementById('score-limit').value = scoreLimit;
                document.getElementById('fixed-multiplier').value = fixedMultiplier;
            }

            start() {
                this.getSettings();
                this.settingsScreen.style.display = 'none';
                this.gameScreen.style.display = 'block';
                this.gameOverScreen.style.display = 'none';

                this.cleanup();
                this.scoreRight = 0;
                this.scoreWrong = 0;
                this.invaders = [];
                this.spawnInterval = 2500;
                
                this.currentAnswer = '';
                this.updateAnswerDisplay();

                this.updateScoreDisplay();
                this.setMultiplier();

                if (this.settings.mode === 'time') {
                    this.timeLeft = this.settings.limit;
                    this.updateStatusDisplay();
                    this.timerId = setInterval(() => {
                        this.timeLeft--;
                        this.updateStatusDisplay();
                        if (this.timeLeft <= 0) {
                            this.endGame(true);
                        }
                    }, 1000);
                } else {
                    this.updateStatusDisplay();
                }

                this.lastSpawnTime = Date.now();
                this.gameLoop();
            }

            cleanup() {
                clearInterval(this.timerId);
                cancelAnimationFrame(this.gameLoopId);
                
                if (this.alertTimer) {
                    clearTimeout(this.alertTimer);
                }
                this.gameAlert.classList.remove('show');
                
                this.invaders.forEach(invader => invader.destroy());
                this.invaders = [];
            }

            setMultiplier() {
                if (this.settings.multiplierMode === 'fixed') {
                    // Use the fixed value from settings
                    this.multiplier = this.settings.fixedMultiplier;
                } else {
                    // Random mode based on difficulty
                    if (this.settings.difficulty === 'single') {
                        this.multiplier = Math.floor(Math.random() * 9) + 1; // 1 to 9
                    } else {
                        this.multiplier = Math.floor(Math.random() * 12) + 1; // 1 to 12
                    }
                }
                this.multiplierDisplay.textContent = `Ã— ${this.multiplier}`;
            }

            spawnInvader() {
                let value;
                if (this.settings.difficulty === 'single') {
                    value = Math.floor(Math.random() * 9) + 1;
                } else {
                    value = Math.floor(Math.random() * 90) + 10;
                }
                this.invaders.push(new Invader(value, this.gameArea, this.settings.speed));
            }

            gameLoop() {
                const now = Date.now();
                
                if (now - this.lastSpawnTime > this.spawnInterval) {
                    this.spawnInvader();
                    this.lastSpawnTime = now;
                    // Slightly increase the spawn rate over time (reduce interval)
                    if (this.spawnInterval > 600) {
                        this.spawnInterval -= 50;
                    }
                }

                for (let i = this.invaders.length - 1; i >= 0; i--) {
                    const invader = this.invaders[i];
                    invader.update();

                    if (invader.isOffScreen()) {
                        invader.destroy();
                        this.invaders.splice(i, 1);
                        this.scoreWrong++;
                        this.updateScoreDisplay();
                    }
                }

                this.gameLoopId = requestAnimationFrame(() => this.gameLoop());
            }

            handleKeypadInput(key) {
                if (key >= '0' && key <= '9') {
                    // Maximum of 5 digits
                    if (this.currentAnswer.length < 5) {
                        this.currentAnswer += key;
                    }
                } else if (key === 'del') {
                    this.currentAnswer = this.currentAnswer.slice(0, -1);
                } else if (key === 'submit') {
                    this.checkAnswer();
                }
                
                this.updateAnswerDisplay();
            }

            updateAnswerDisplay() {
                this.answerDisplay.textContent = this.currentAnswer === '' ? '0' : this.currentAnswer;
            }

            checkAnswer() {
                if (this.currentAnswer === '') return;
                
                const answer = parseInt(this.currentAnswer, 10);
                let correctInvaderIndex = -1;

                // Check if the answer matches any invader's problem
                for (let i = 0; i < this.invaders.length; i++) {
                    // Calculate the required answer for this invader
                    const requiredAnswer = this.invaders[i].value * this.multiplier;
                    
                    if (requiredAnswer === answer) {
                        correctInvaderIndex = i;
                        break;
                    }
                }

                if (correctInvaderIndex !== -1) {
                    // Correct answer
                    this.invaders[correctInvaderIndex].destroy();
                    this.invaders.splice(correctInvaderIndex, 1);
                    this.scoreRight++;
                    this.updateScoreDisplay();
                    this.showAlert("Correct!", "correct");

                    if (this.settings.mode === 'score' && this.scoreRight >= this.settings.limit) {
                        this.endGame(true);
                    }
                } else {
                    // Incorrect answer
                    this.scoreWrong++;
                    this.updateScoreDisplay();
                    this.showAlert("Wrong!", "wrong");
                }
                
                // Clear the answer state and update display
                this.currentAnswer = '';
                this.updateAnswerDisplay();
            }
            
            showAlert(message, type) {
                if (this.alertTimer) {
                    clearTimeout(this.alertTimer);
                }

                this.gameAlert.textContent = message;
                this.gameAlert.classList.remove('correct', 'wrong', 'show');
                this.gameAlert.classList.add(type);
                this.gameAlert.classList.add('show');

                this.alertTimer = setTimeout(() => {
                    this.gameAlert.classList.remove('show');
                    this.alertTimer = null;
                }, 800);
            }

            updateScoreDisplay() {
                this.scoreRightDisplay.textContent = this.scoreRight;
                this.scoreWrongDisplay.textContent = this.scoreWrong;
            }

            updateStatusDisplay() {
                if (this.settings.mode === 'time') {
                    this.gameStatusDisplay.textContent = `Time: ${this.timeLeft}s`;
                } else {
                    this.gameStatusDisplay.textContent = `Score: ${this.scoreRight} / ${this.settings.limit}`;
                }
            }

            endGame(didWin) {
                this.cleanup();
                this.gameScreen.style.display = 'none';
                this.gameOverScreen.style.display = 'block';

                if (this.settings.mode === 'score' && didWin) {
                    this.gameOverTitle.textContent = "You Win!";
                } else {
                    this.gameOverTitle.textContent = "Time's Up!";
                }

                this.finalScoreRight.textContent = this.scoreRight;
                this.finalScoreWrong.textContent = this.scoreWrong;
            }
        }

        // Initialize the game once the DOM is loaded.
        document.addEventListener('DOMContentLoaded', () => {
            const game = new Game();
            game.showSettings();
        });
